
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>automatminer.featurization.core &#8212; automatminer 2019.03.27_beta documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for automatminer.featurization.core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes for automatic featurization and core featurizer functionality.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pymatgen</span> <span class="k">import</span> <span class="n">Composition</span>
<span class="kn">from</span> <span class="nn">matminer.featurizers.conversions</span> <span class="k">import</span> <span class="n">StrToComposition</span><span class="p">,</span> <span class="n">DictToObject</span><span class="p">,</span> \
    <span class="n">StructureToComposition</span><span class="p">,</span> <span class="n">StructureToOxidStructure</span><span class="p">,</span> \
    <span class="n">CompositionToOxidComposition</span>
<span class="kn">from</span> <span class="nn">matminer.featurizers.function</span> <span class="k">import</span> <span class="n">FunctionFeaturizer</span>

<span class="kn">from</span> <span class="nn">automatminer.utils.log</span> <span class="k">import</span> <span class="n">log_progress</span><span class="p">,</span> <span class="n">AMM_LOG_FIT_STR</span><span class="p">,</span> \
    <span class="n">AMM_LOG_TRANSFORM_STR</span>
<span class="kn">from</span> <span class="nn">automatminer.utils.pkg</span> <span class="k">import</span> <span class="n">check_fitted</span><span class="p">,</span> <span class="n">set_fitted</span>
<span class="kn">from</span> <span class="nn">automatminer.base</span> <span class="k">import</span> <span class="n">DFTransformer</span><span class="p">,</span> <span class="n">LoggableMixin</span>
<span class="kn">from</span> <span class="nn">automatminer.featurization.sets</span> <span class="k">import</span> <span class="n">CompositionFeaturizers</span><span class="p">,</span> \
    <span class="n">StructureFeaturizers</span><span class="p">,</span> <span class="n">BSFeaturizers</span><span class="p">,</span> <span class="n">DOSFeaturizers</span>
<span class="kn">from</span> <span class="nn">automatminer.utils.pkg</span> <span class="k">import</span> <span class="n">AutomatminerError</span>
<span class="kn">from</span> <span class="nn">automatminer.utils.ml</span> <span class="k">import</span> <span class="n">regression_or_classification</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Alex Dunn &lt;ardunn@lbl.gov&gt;&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Alireza Faghaninia &lt;alireza@lbl.gov&gt;&quot;</span><span class="p">,</span>
              <span class="s2">&quot;Qi Wang &lt;wqthu11@gmail.com&gt;&quot;</span><span class="p">]</span>

<span class="n">_COMMON_COL_ERR_STR</span> <span class="o">=</span> <span class="s2">&quot;composition_col/structure_col/bandstructure_col/dos_col&quot;</span>


<div class="viewcode-block" id="AutoFeaturizer"><a class="viewcode-back" href="../../../api/automatminer.featurization.core.AutoFeaturizer.html#automatminer.AutoFeaturizer">[docs]</a><span class="k">class</span> <span class="nc">AutoFeaturizer</span><span class="p">(</span><span class="n">DFTransformer</span><span class="p">,</span> <span class="n">LoggableMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatically featurize a dataframe.</span>

<span class="sd">    Use this object first by calling fit, then by calling transform.</span>

<span class="sd">    AutoFeaturizer requires you to specify the column names for each type of</span>
<span class="sd">        featurization, or just use the defaults:</span>

<span class="sd">        &quot;composition&quot;: To use composition features</span>
<span class="sd">        &quot;structure&quot;: To use structure features</span>
<span class="sd">        &quot;bandstructure&quot;: To use bandstructure features</span>
<span class="sd">        &quot;dos&quot;: To use density of states features</span>

<span class="sd">    The featurizers corresponding to each featurizer type cannot be used if</span>
<span class="sd">    the correct column name is not present.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_src (str): An absolute path to a json file holding feature</span>
<span class="sd">            information. If file exists, will read features (loc indexwise)</span>
<span class="sd">            from this file instead of featurizing. If this file does not exist,</span>
<span class="sd">            AutoFeaturizer will featurize normally, then save the features to a</span>
<span class="sd">            new file. Only features (not featurizer input objects) will be saved</span>
<span class="sd">        preset (str): &quot;best&quot; or &quot;fast&quot; or &quot;all&quot;. Determines by preset the</span>
<span class="sd">            featurizers that should be applied. See the Featurizer sets for</span>
<span class="sd">            specifics of best/fast/all. Default is &quot;best&quot;. Incompatible with</span>
<span class="sd">            the featurizers arg.</span>
<span class="sd">        featurizers (dict): Use this option if you want to manually specify</span>
<span class="sd">            the featurizers to use. Keys are the featurizer types you want</span>
<span class="sd">            applied (e.g., &quot;structure&quot;, &quot;composition&quot;). The corresponding values</span>
<span class="sd">            are lists of featurizer objects you want for each featurizer type.</span>

<span class="sd">            Example:</span>
<span class="sd">                 {&quot;composition&quot;: [ElementProperty.from_preset(&quot;matminer&quot;),</span>
<span class="sd">                                  EwaldEnergy()]</span>
<span class="sd">                  &quot;structure&quot;: [BagofBonds(), GlobalSymmetryFeatures()]}</span>

<span class="sd">        exclude ([str]): Class names of featurizers to exclude. Only used if</span>
<span class="sd">            you use a preset.</span>
<span class="sd">        ignore_cols ([str]): Column names to be ignored/removed from any</span>
<span class="sd">            dataframe undergoing fitting or transformation. If columns are</span>
<span class="sd">            not ignored, they may be used later on for learning.</span>
<span class="sd">        ignore_errors (bool): If True, each featurizer will ignore all errors</span>
<span class="sd">            during featurization.</span>
<span class="sd">        drop_inputs (bool): Drop the columns containing input objects for</span>
<span class="sd">            featurization after they are featurized.</span>
<span class="sd">        guess_oxistates (bool): If True, try to decorate sites with oxidation</span>
<span class="sd">            state.</span>
<span class="sd">        multiiindex (bool): If True, returns a multiindexed dataframe. Not</span>
<span class="sd">            recommended for use in MatPipe.</span>
<span class="sd">        n_jobs (int): The number of parallel jobs to use during featurization</span>
<span class="sd">            for each featurizer. Default is n_cores</span>
<span class="sd">        logger (Logger, bool): A custom logger object to use for logging.</span>
<span class="sd">            Alternatively, if set to True, the default automatminer logger will</span>
<span class="sd">            be used. If set to False, then no logging will occur.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        These attributes are set during fitting</span>

<span class="sd">        featurizers (dict): Same format as input dictionary in Args. Values</span>
<span class="sd">            contain the actual objects being used for featurization. Featurizers</span>
<span class="sd">            can be removed if check_validity=True and the featurizer is not</span>
<span class="sd">            valid for more than self.min_precheck_frac fraction of the fitting</span>
<span class="sd">            dataset.</span>
<span class="sd">        features (dict): The features generated from the application of all</span>
<span class="sd">            featurizers.</span>
<span class="sd">        auto_featurizer (bool): whether the featurizers are set automatically,</span>
<span class="sd">            or passed by the users.</span>
<span class="sd">        fitted_input_df (pd.DataFrame): The dataframe which was fitted on</span>
<span class="sd">        converted_input_df (pd.DataFrame): The converted dataframe which</span>
<span class="sd">            was fitted on (i.e., strings converted to compositions).</span>

<span class="sd">        Attributes not set during fitting and not specified by arguments:</span>

<span class="sd">        min_precheck_frac (float): The minimum fraction of a featuriser&#39;s input</span>
<span class="sd">            that can be valid (via featurizer.precheck(data).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_src</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">featurizers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">functionalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">guess_oxistates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">multiindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_precheck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">composition_col</span><span class="o">=</span><span class="s2">&quot;composition&quot;</span><span class="p">,</span>
                 <span class="n">structure_col</span><span class="o">=</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="n">bandstructure_col</span><span class="o">=</span><span class="s2">&quot;bandstructure&quot;</span><span class="p">,</span>
                 <span class="n">dos_col</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">featurizers</span> <span class="ow">and</span> <span class="n">preset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AutomatminerError</span><span class="p">(</span><span class="s2">&quot;Featurizers and preset were both set. &quot;</span>
                                    <span class="s2">&quot;Please either use a preset (&#39;best&#39;, &#39;all&#39;,&quot;</span>
                                    <span class="s2">&quot; &#39;fast&#39;) or set featurizers manually.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">featurizers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">preset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AutomatminerError</span><span class="p">(</span><span class="s2">&quot;Please specify set(s) of featurizers to &quot;</span>
                                    <span class="s2">&quot;use either through the featurizers&quot;</span>
                                    <span class="s2">&quot;argument or through the preset argument.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span> <span class="o">=</span> <span class="n">cache_src</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preset</span> <span class="o">=</span> <span class="s2">&quot;best&quot;</span> <span class="k">if</span> <span class="n">preset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">preset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span> <span class="o">=</span> <span class="n">featurizers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span> <span class="k">if</span> <span class="n">exclude</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functionalize</span> <span class="o">=</span> <span class="n">functionalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_cols</span> <span class="o">=</span> <span class="n">ignore_cols</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_fit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_input_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converted_input_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_errors</span> <span class="o">=</span> <span class="n">ignore_errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_inputs</span> <span class="o">=</span> <span class="n">drop_inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiindex</span> <span class="o">=</span> <span class="n">multiindex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_precheck</span> <span class="o">=</span> <span class="n">do_precheck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guess_oxistates</span> <span class="o">=</span> <span class="n">guess_oxistates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_featurizer</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_col</span> <span class="o">=</span> <span class="n">composition_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure_col</span> <span class="o">=</span> <span class="n">structure_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandstruct_col</span> <span class="o">=</span> <span class="n">bandstructure_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dos_col</span> <span class="o">=</span> <span class="n">dos_col</span>

        <span class="n">_supported_featurizers</span> <span class="o">=</span> <span class="p">{</span><span class="n">composition_col</span><span class="p">:</span> <span class="n">CompositionFeaturizers</span><span class="p">,</span>
                                  <span class="n">structure_col</span><span class="p">:</span> <span class="n">StructureFeaturizers</span><span class="p">,</span>
                                  <span class="n">bandstructure_col</span><span class="p">:</span> <span class="n">BSFeaturizers</span><span class="p">,</span>
                                  <span class="n">dos_col</span><span class="p">:</span> <span class="n">DOSFeaturizers</span><span class="p">}</span>

        <span class="c1"># user-set featurizers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Featurizers must be a dictionary with keys&quot;</span>
                                <span class="s2">&quot;matching your </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_COMMON_COL_ERR_STR</span><span class="p">))</span>

            <span class="n">invalid_ftypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span>
                              <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_supported_featurizers</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">invalid_ftypes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;The following keys were specified as featurizer&quot;</span>
                               <span class="s2">&quot; types but were not set in </span><span class="si">{}</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_COMMON_COL_ERR_STR</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">ftype</span><span class="p">,</span> <span class="n">fset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_allowed</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>
                            <span class="n">_supported_featurizers</span><span class="p">[</span><span class="n">ftype</span><span class="p">]()</span><span class="o">.</span><span class="n">all</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fset</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_allowed</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> featurizer </span><span class="si">{}</span><span class="s2"> is not supported by &quot;</span>
                            <span class="s2">&quot;AutoFeaturizer. Try updating your version of &quot;</span>
                            <span class="s2">&quot;automatminer and matminer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

        <span class="c1"># auto-set featurizers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">featurizers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">featurizer_type</span> <span class="ow">in</span> <span class="n">_supported_featurizers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">featurizer_set</span> <span class="o">=</span> <span class="n">_supported_featurizers</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]</span>
                <span class="n">featurizers</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">featurizer_set</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">preset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span> <span class="o">=</span> <span class="n">featurizers</span>

        <span class="c1"># Check if any featurizers need fitting (useful for MatPipe)</span>
        <span class="n">needs_fit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fittable_fs</span> <span class="o">=</span> <span class="n">StructureFeaturizers</span><span class="p">()</span><span class="o">.</span><span class="n">need_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fittable_fcls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fittable_fs</span><span class="p">])</span>

        <span class="c1"># Currently structure featurizers are the only featurizer types which</span>
        <span class="c1"># can be fittable</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_col</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fittable_fcls</span><span class="p">:</span>
                <span class="n">needs_fit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needs_fit</span> <span class="o">=</span> <span class="n">needs_fit</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_fit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                             <span class="s2">&quot;Using cached features on fittable featurizers! &quot;</span>
                             <span class="s2">&quot;Please make sure you are not benchmarking with &quot;</span>
                             <span class="s2">&quot;these options enabled; it is likely you will be&quot;</span>
                             <span class="s2">&quot;leaking data (i.e., features) from the testing&quot;</span>
                             <span class="s2">&quot;sets into the training.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span> <span class="ow">and</span> <span class="s2">&quot;json&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The cache_src filename does not contain json.&quot;</span>
                             <span class="s2">&quot;JSON is the required file type for featurizer&quot;</span>
                             <span class="s2">&quot;caching.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">min_precheck_frac</span> <span class="o">=</span> <span class="mf">0.9</span>

    <span class="nd">@log_progress</span><span class="p">(</span><span class="n">AMM_LOG_FIT_STR</span><span class="p">)</span>
    <span class="nd">@set_fitted</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit all featurizers to the df and remove featurizers which are out of</span>
<span class="sd">        scope or otherwise cannot be robustly applied to the dataset.</span>

<span class="sd">        WARNING: for fitting to work, the dataframe must contain the</span>
<span class="sd">        corresponding *col keys set in __init__. So for composition</span>
<span class="sd">        featurization to work, you must have the composition_col in the</span>
<span class="sd">        dataframe.</span>

<span class="sd">            Composition features: composition_col - pymatgen Composition objs</span>
<span class="sd">            Structure features: structure_col - pymatgen Structure objs</span>
<span class="sd">            Bandstructure features: bandstructure_col - pymatgen Bandstructure</span>
<span class="sd">                objs</span>
<span class="sd">            DOS features: dos_col - pymatgen DOS objs</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): A dataframe containing at least one of the</span>
<span class="sd">                keys listed above. The column defined by that key should have</span>
<span class="sd">                the corresponding types of objects in it.</span>
<span class="sd">            target (str): The ML target key in the dataframe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (AutoFeaturizer): self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                             <span class="s2">&quot;Cache </span><span class="si">{}</span><span class="s2"> found. Fit aborted.&quot;</span>
                             <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_input_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prescreen_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_composition_from_structure</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">featurizer_type</span><span class="p">,</span> <span class="n">featurizers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">featurizers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                    <span class="s2">&quot;No </span><span class="si">{}</span><span class="s2"> featurizers being used.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">featurizer_type</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">featurizer_type</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tidy_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">)</span>

                <span class="c1"># Remove invalid featurizers by looking at valid_fraction</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_precheck</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                      <span class="s2">&quot;Prechecking featurizers.&quot;</span><span class="p">)</span>
                    <span class="n">invalid_featurizers</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">featurizers</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">frac</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">precheck_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">,</span>
                                                        <span class="n">return_frac</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">frac</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_precheck_frac</span><span class="p">:</span>
                                <span class="n">invalid_featurizers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Will remove </span><span class="si">{}</span><span class="s2"> because it&#39;s fraction &quot;</span> \
                                      <span class="s2">&quot;passing the precheck for this &quot;</span> \
                                      <span class="s2">&quot;dataset (</span><span class="si">{}</span><span class="s2">) was less than the minimum&quot;</span> \
                                      <span class="s2">&quot; (</span><span class="si">{}</span><span class="s2">)&quot;</span> \
                                      <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">min_precheck_frac</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">E</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> precheck failed with </span><span class="si">{}</span><span class="s2">. Ignoring....&quot;</span>
                                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">E</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">featurizers</span>
                                                         <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span>
                                                         <span class="n">invalid_featurizers</span><span class="p">]</span>
                    <span class="n">featurizers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]</span>

                <span class="c1"># Fit the featurizers</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">featurizers</span><span class="p">:</span>
                    <span class="n">log_fit</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">featurizer_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_col</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fittable_fcls</span><span class="p">:</span>
                            <span class="n">log_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">log_fit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                            <span class="s2">&quot;Fitting </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

                    <span class="n">f</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">set_n_jobs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">feature_labels</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">log_fit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                            <span class="s2">&quot;Fit </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> samples in dataframe.&quot;</span>
                            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                 <span class="s2">&quot;Featurizer type </span><span class="si">{}</span><span class="s2"> not in the dataframe to be&quot;</span>
                                 <span class="s2">&quot; fitted. Skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">featurizer_type</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converted_input_df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@log_progress</span><span class="p">(</span><span class="n">AMM_LOG_TRANSFORM_STR</span><span class="p">)</span>
    <span class="nd">@check_fitted</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decorate a dataframe containing composition, structure, bandstructure,</span>
<span class="sd">        and/or DOS objects with descriptors.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): The dataframe not containing features.</span>
<span class="sd">            target (str): The ML-target property contained in the df.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pandas.DataFrame): Transformed dataframe containing features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                              <span class="s2">&quot;Reading cache_src </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">))</span>
            <span class="n">cached_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">loc</span> <span class="ow">in</span> <span class="n">cached_df</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">AutomatminerError</span><span class="p">(</span><span class="s2">&quot;Feature cache does not contain all &quot;</span>
                                        <span class="s2">&quot;entries (by DataFrame index) needed &quot;</span>
                                        <span class="s2">&quot;to transform the input df.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cached_subdf</span> <span class="o">=</span> <span class="n">cached_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">cached_subdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                            <span class="s2">&quot;Target not present in both cached df and input df.&quot;</span>
                            <span class="s2">&quot; Cannot perform comparison to ensure index match.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cached_targets</span> <span class="o">=</span> <span class="n">cached_subdf</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
                        <span class="n">input_targets</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
                        <span class="n">cached_type</span> <span class="o">=</span> <span class="n">regression_or_classification</span><span class="p">(</span>
                            <span class="n">cached_targets</span><span class="p">)</span>
                        <span class="n">input_type</span> <span class="o">=</span> <span class="n">regression_or_classification</span><span class="p">(</span><span class="n">input_targets</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">cached_type</span> <span class="o">!=</span> <span class="n">input_type</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">AutomatminerError</span><span class="p">(</span>
                                <span class="s2">&quot;Cached targets appear to be &#39;</span><span class="si">{}</span><span class="s2">&#39; type, while &quot;</span>
                                <span class="s2">&quot;input targets appear to be &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span>
                                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cached_type</span><span class="p">,</span> <span class="n">input_type</span><span class="p">))</span>

                        <span class="n">problems</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">input_targets</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">iv</span> <span class="o">=</span> <span class="n">input_targets</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                            <span class="n">cv</span> <span class="o">=</span> <span class="n">cached_targets</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">iv</span> <span class="o">!=</span> <span class="n">cv</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">cv</span><span class="p">):</span>
                                        <span class="n">problems</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">iv</span><span class="p">,</span> <span class="n">cv</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                                    <span class="k">pass</span>
                        <span class="k">if</span> <span class="n">problems</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                <span class="s2">&quot;Mismatch between cached targets and input &quot;</span>
                                <span class="s2">&quot;targets: </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">problems</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                 <span class="s2">&quot;Restored </span><span class="si">{}</span><span class="s2"> features on </span><span class="si">{}</span><span class="s2"> samples from &quot;</span>
                                 <span class="s2">&quot;cache </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cached_subdf</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">cached_subdf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transforming_on_fitted</span> <span class="o">=</span> <span class="n">df</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_input_df</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prescreen_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">transforming_on_fitted</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_input_df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_composition_from_structure</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">featurizer_type</span><span class="p">,</span> <span class="n">featurizers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">featurizer_type</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">transforming_on_fitted</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tidy_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">featurizers</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                         <span class="s2">&quot;Featurizing with </span><span class="si">{}</span><span class="s2">.&quot;</span>
                                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span>
                            <span class="n">df</span><span class="p">,</span>
                            <span class="n">featurizer_type</span><span class="p">,</span>
                            <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_errors</span><span class="p">,</span>
                            <span class="n">multiindex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiindex</span><span class="p">,</span>
                            <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_inputs</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                     <span class="s2">&quot;Featurizer type </span><span class="si">{}</span><span class="s2"> not in the dataframe. &quot;</span>
                                     <span class="s2">&quot;Skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">featurizer_type</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">functionalize</span><span class="p">:</span>
                <span class="n">ff</span> <span class="o">=</span> <span class="n">FunctionFeaturizer</span><span class="p">()</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="n">cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">fit_featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span>
                                                <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_errors</span><span class="p">,</span>
                                                <span class="n">multiindex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiindex</span><span class="p">,</span>
                                                <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_src</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_prescreen_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pre-screen a dataframe.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): The dataframe to be screened.</span>
<span class="sd">            inplace (bool): Manipulate the df in-place in memory</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pandas.DataFrame) The screened dataframe.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_tidy_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Various conversions to homogenize columns for featurization input.</span>
<span class="sd">        For example, take a column of compositions and ensure they are decorated</span>
<span class="sd">        with oxidation states, are not strings, etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame)</span>
<span class="sd">            featurizer_type: The key defining the featurizer input. For example,</span>
<span class="sd">                composition featurizers should have featurizer_type of</span>
<span class="sd">                &quot;composition&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame with featurizer_type column</span>
<span class="sd">                ready for featurization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: Make the following conversions more robust (no [0] type checking)</span>
        <span class="n">type_tester</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">featurizer_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_col</span><span class="p">:</span>
            <span class="c1"># Convert formulas to composition objects</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_tester</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                 <span class="s2">&quot;Compositions detected as strings. Attempting &quot;</span>
                                 <span class="s2">&quot;conversion to Composition objects...&quot;</span><span class="p">)</span>
                <span class="n">stc</span> <span class="o">=</span> <span class="n">StrToComposition</span><span class="p">(</span><span class="n">overwrite_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">target_col_id</span><span class="o">=</span><span class="n">featurizer_type</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">stc</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">,</span>
                                             <span class="n">multiindex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiindex</span><span class="p">,</span>
                                             <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_tester</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                 <span class="s2">&quot;Compositions detected as dicts. Attempting &quot;</span>
                                 <span class="s2">&quot;conversion to Composition objects...&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Composition</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span>
                                       <span class="n">df</span><span class="p">[</span><span class="n">featurizer_type</span><span class="p">]]</span>

            <span class="c1"># Convert non-oxidstate containing comps to oxidstate comps</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_oxistates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                 <span class="s2">&quot;Guessing oxidation states of compositions, as&quot;</span>
                                 <span class="s2">&quot; they were not present in input.&quot;</span><span class="p">)</span>
                <span class="n">cto</span> <span class="o">=</span> <span class="n">CompositionToOxidComposition</span><span class="p">(</span>
                    <span class="n">target_col_id</span><span class="o">=</span><span class="n">featurizer_type</span><span class="p">,</span> <span class="n">overwrite_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">return_original_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_sites</span><span class="o">=-</span><span class="mi">50</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">cto</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">,</span>
                                                 <span class="n">multiindex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiindex</span><span class="p">,</span>
                                                 <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                     <span class="s2">&quot;Could not decorate oxidation states due &quot;</span>
                                     <span class="s2">&quot;to </span><span class="si">{}</span><span class="s2">. Excluding featurizers based on &quot;</span>
                                     <span class="s2">&quot;composition oxistates&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="n">classes_require_oxi</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
                                           <span class="n">CompositionFeaturizers</span><span class="p">()</span><span class="o">.</span><span class="n">need_oxi</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">classes_require_oxi</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert structure/bs/dos dicts to objects (robust already)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_tester</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span>
                                 <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> detected as string or dict. Attempting &quot;</span>
                                 <span class="s2">&quot;conversion to </span><span class="si">{}</span><span class="s2"> objects...&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">featurizer_type</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_tester</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> column is type </span><span class="si">{}</span><span class="s2">. Cannot convert.&quot;</span>
                        <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">featurizer_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">type_tester</span><span class="p">)))</span>
                <span class="n">dto</span> <span class="o">=</span> <span class="n">DictToObject</span><span class="p">(</span><span class="n">overwrite_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">target_col_id</span><span class="o">=</span><span class="n">featurizer_type</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Decorate with oxidstates</span>
                <span class="k">if</span> <span class="n">featurizer_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_col</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">guess_oxistates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                        <span class="s2">&quot;Guessing oxidation states of structures if they were &quot;</span>
                        <span class="s2">&quot;not present in input.&quot;</span><span class="p">)</span>
                    <span class="n">sto</span> <span class="o">=</span> <span class="n">StructureToOxidStructure</span><span class="p">(</span>
                        <span class="n">target_col_id</span><span class="o">=</span><span class="n">featurizer_type</span><span class="p">,</span> <span class="n">overwrite_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">return_original_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_sites</span><span class="o">=-</span><span class="mi">50</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">sto</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">featurizer_type</span><span class="p">,</span>
                                                     <span class="n">multiindex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiindex</span><span class="p">,</span>
                                                     <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                            <span class="s2">&quot;Could not decorate oxidation states on structures &quot;</span>
                            <span class="s2">&quot;due to </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_add_composition_from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically deduce compositions from structures if:</span>

<span class="sd">            1. structures are available</span>
<span class="sd">            2. compositions are not available (unless overwrite)</span>
<span class="sd">            3. composition features are actually desired. (deduced from whether</span>
<span class="sd">                composition featurizers are present in self.featurizers).</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pandas.DataFrame): May or may not contain composition column.</span>
<span class="sd">            overwrite (bool): Whether to overwrite the composition column if it</span>
<span class="sd">                already exists.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pandas.DataFrame): Contains composition column if desired</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> \
                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="n">overwrite</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizers</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                 <span class="s2">&quot;composition column already exists, &quot;</span>
                                 <span class="s2">&quot;overwriting with composition from structure.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_prefix</span> <span class="o">+</span>
                                 <span class="s2">&quot;Adding compositions from structures.&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tidy_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_col</span><span class="p">)</span>

            <span class="c1"># above tidy column will add oxidation states, these oxidation</span>
            <span class="c1"># states will then be transferred to composition.</span>
            <span class="n">struct2comp</span> <span class="o">=</span> <span class="n">StructureToComposition</span><span class="p">(</span>
                <span class="n">target_col_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_col</span><span class="p">,</span> <span class="n">overwrite_data</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">struct2comp</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>
</pre></div>

          </div>
          
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Alex Dunn.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>